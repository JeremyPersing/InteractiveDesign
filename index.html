<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        max-width: 960px;
        margin: 0 auto;
        float: none;
      }

      .header {
        margin-left: 2em;
      }

      .names {
        fill: none;
        stroke: #fff;
        stroke-linejoin: round;
      }

      .center {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <div class="header">
      <div>
        <h1>Aid Effectiveness Visualizations</h1>
        <h5>By Jeremy Persing & Kaitlin Arens</h5>
      </div>
    </div>
    <div id="div_template"></div>
    <div id="textbox" class="center"></div>
    <script>
      var format = d3.format(",");

      // The world map
      var margin = { top: 0, right: 0, bottom: 0, left: 0 },
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

      // colors
      var color = d3
        .scaleThreshold()
        .domain([
          10000, 100000, 500000, 1000000, 5000000, 10000000, 50000000,
          100000000, 500000000, 1500000000,
        ])
        .range([
          "rgb(243,78,78)",
          "rgb(222,235,247)",
          "rgb(198,219,239)",
          "rgb(158,202,225)",
          "rgb(107,174,214)",
          "rgb(66,146,198)",
          "rgb(33,113,181)",
          "rgb(215,151,156)",
          "rgb(8,48,107)",
          "rgb(3,19,43)",
        ]);

      var path = d3.geoPath();

      // rendering the map
      var svg = d3
        .select("#div_template")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("class", "map");

      var projection = d3
        .geoMercator()
        .scale(130)
        .translate([width / 2, height / 1.5]);

      var path = d3.geoPath().projection(projection);

      // svg.call(tip);
      var Tooltip = d3
        .select("#d3_template")
        .append("div")
        .style("opacity", 0)
        .attr("class", "tooltip")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "2px")
        .style("border-radius", "5px")
        .style("padding", "5px");

      queue()
        .defer(d3.json, "world.geojson")
        .defer(d3.tsv, "world_population.tsv")
        .await(ready);

      function ready(error, data, population) {
        var populationById = {};

        population.forEach(function (d) {
          populationById[d.id] = +d.population;
        });
        data.features.forEach(function (d) {
          d.population = populationById[d.id];
        });

        svg
          .append("g")
          .attr("class", "countries")
          .selectAll("path")
          .data(data.features)
          .enter()
          .append("path")
          .attr("d", path)
          .style("fill", function (d) {
            return color(populationById[d.id]);
          })
          .style("stroke", "white")
          .style("stroke-width", 1.5)
          .style("opacity", 0.8)
          // tooltips
          .style("stroke", "white")
          .style("stroke-width", 0.3)
          .on("mouseover", function (d) {
            let name = d.properties.name;
            let population = format(d.population);
            console.log(population);
            console.log(name);
            let string =
              "<strong>Country: </strong><span>" +
              name +
              "<br></span>" +
              "<strong>Population: </strong><span>" +
              population;
            ("</span>");
            d3.select(this)
              .style("opacity", 1)
              .style("stroke", "white")
              .style("stroke-width", 3);
            // tip.show(d); comment
            d3.select("#textbox")
              .html("")
              .append("text")
              .html(() => string);
          })
          .on("mouseout", function (d) {
            // tip.hide(d); comment

            d3.select(this)
              .style("opacity", 0.8)
              .style("stroke", "white")
              .style("stroke-width", 0.3);
          });

        svg
          .append("path")
          .datum(
            topojson.mesh(data.features, function (a, b) {
              return a.id !== b.id;
            })
          )
          .attr("class", "names")
          .attr("d", path);
      }
    </script>
    <div id="tooltip"></div>
  </body>
</html>
